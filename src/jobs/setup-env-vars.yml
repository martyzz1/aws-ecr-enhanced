parameters:
  env-var-file:
    default: 'custom-env-vars'
    description: >-
      Path to a custom env var file which will be passed to >> $BASH_ENV
      Ideal for passing environment variables from earlier jobs
      Most useful for Image tagging
      Defaults to 'custom-env-vars'.
    type: string
  executor:
    type: executor
    default: default
    description: executor to use for this job
  full-image-tag:
    description: >-
      String to be used for the FULL_IMAGE_TAG Env variable value
    type: string
  persist-to-workspace:
    description: >-
      Store the current env-var-file using persist_to_workspace.
      Set to false if setting multiple env vars in a job, and set to true on the last one.
    default: true
    type: boolean
  repo:
    description: Name of an Amazon ECR repository
    type: string

executor: <<parameters.executor>>
steps:
  - checkout
  - run:
      name: "Persist CIRCLE_BUILD_NUM environment variables"
      command: |
        echo "export FULL_IMAGE_TAG='<< parameters.full-image-tag >>'" >> << parameters.env-var-file >>
        echo "export REPO='<< parameters.repo >>'" >> << parameters.env-var-file >>
  - run:
      name: get the workspace root and relative path
      command: |
        DIRECTORY="<<parameters.env-var-file>>"
        REMAINING_DIRECTORY=$(echo ${DIRECTORY#/})
        WORKING_REMAINING_DIRECTORY=$(echo ${CIRCLE_WORKING_DIRECTORY#/})
        echo "export WORKING_REMAINING_DIRECTORY='${WORKING_REMAINING_DIRECTORY}'" >> <<parameters.env-var-file>>
        echo "export REMAINING_DIRECTORY='${REMAINING_DIRECTORY}'" >> <<parameters.env-var-file>>
        cat <<parameters.env-var-file>> >> $BASH_ENV
        cat <<parameters.env-var-file>>

  - when:
      condition: <<parameters.persist-to-workspace>>
      steps:
        - persist_to_workspace:
            root: .
            paths:
              - <<parameters.env-var-file>>
